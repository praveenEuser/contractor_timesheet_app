'use strict';

const sessionCookieProvider = require('./session-cookie-provider');
const stripClientCookies = require('./strip-client-cookies');
const {setBackendCookiesEnabled} = require('../utils/cookie-utils');

module.exports = function sessionCookieMiddleware(sessionCookieName) {
  return function (req, res, next) {
    if (!req.session || !req.internalUrl) {
      return next();
    }
    if (!setBackendCookiesEnabled(req)) {
      stripClientCookies(req, sessionCookieName);
    }
    sessionCookieProvider(req, function (err, cookies) {
      if (err) {
        return next(err);
      }
      if (cookies) {
        req.headers.cookie = req.headers.cookie ? req.headers.cookie + '; ' + cookies : cookies;
      }
      next();
    });
  };
};
